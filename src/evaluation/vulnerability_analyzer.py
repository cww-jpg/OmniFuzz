import logging
from typing import Dict, List, Any
import json

class VulnerabilityAnalyzer:
    """漏洞分析器"""

    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self.vulnerability_db = self._load_vulnerability_database()

    def _load_vulnerability_database(self) -> Dict[str, Any]:
        """加载漏洞数据库"""
        # 模拟漏洞数据库
        return {
            'buffer_overflow': {
                'cwe_id': 'CWE-119',
                'severity': 'high',
                'description': '缓冲区溢出',
                'common_locations': ['协议解析',数据包处理'],
                'exploit_impact': '远程代码执行'
            },
            'integer_overflow': {
                'cwe_id': 'CWE-190',
                'severity': 'medium',
                'description': '整数溢出',
                'common_locations': ['长度计算', '索引操作'],
                'exploit_impact': '拒绝服务或代码执行'
            },
            'format_string': {
                'cwe_id': 'CWE-134',
                'severity': 'medium',
                'description': '格式化字符串漏洞',
                'common_locations': ['日志记录', '错误处理'],
                'exploit_impact': '信息泄露或代码执行'
            },
            'use_after_free': {
                'cwe_id': 'CWE-416',
                'severity': 'high',
                'description': '释放后使用',
                'common_locations': ['内存管理', '对象生命周期'],
                'exploit_impact': '代码执行'
            },
            'double_free': {
                'cwe_id': 'CWE-415',
                'severity': 'high',
                'description': '双重释放',
                'common_locations': ['内存管理'],
                'exploit_impact': '代码执行'
            }
        }

    def analyze_vulnerabilities(self, vulnerabilities: List[Dict[str, Any]]) -> Dict[str, Any]:
        """分析漏洞集合"""
        analysis = {
            'total_vulnerabilities': len(vulnerabilities),
            'by_severity': {},
            'by_type': {},
            'by_protocol': {},
            'risk_assessment': {},
            'trends': {}
        }

        for vuln in vulnerabilities:
            # 按严重程度统计
            severity = vuln.get('severity', 'unknown')
            analysis['by_severity'][severity] = analysis['by_severity'].get(severity, 0) + 1

            # 按漏洞类型统计
            vuln_type = vuln.get('type', 'unknown')
            analysis['by_type'][vuln_type] = analysis['by_type'].get(vuln_type, 0) + 1

            # 按协议统计
            protocol = vuln.get('protocol', 'unknown')
            analysis['by_protocol'][protocol] = analysis['by_protocol'].get(protocol, 0) + 1

        # 风险评估
        analysis['risk_assessment'] = self._assess_risk(analysis)

        return analysis

    def _assess_risk(self, analysis: Dict[str, Any]) -> Dict[str, Any]:
        """评估整体风险"""
        critical_count = analysis['by_severity'].get('critical', 0)
        major_count = analysis['by_severity'].get('major', 0)
        total_vulns = analysis['total_vulnerabilities']

        # 计算风险分数
        risk_score = (critical_count * 10 + major_count * 5) / max(1, total_vulns)

        if risk_score >= 8:
            risk_level = 'critical'
        elif risk_score >= 5:
            risk_level = 'high'
        elif risk_score >= 3:
            risk_level = 'medium'
        else:
            risk_level = 'low'

        return {
            'risk_score': risk_score,
            'risk_level': risk_level,
            'critical_vulnerabilities': critical_count,
            'major_vulnerabilities': major_count,
            'recommendations': self._generate_recommendations(analysis)
        }

    def _generate_recommendations(self, analysis: Dict[str, Any]) -> List[str]:
        """生成修复建议"""
        recommendations = []

        # 基于漏洞类型的建议
        for vuln_type, count in analysis['by_type'].items():
            if vuln_type in self.vulnerability_db:
                db_info = self.vulnerability_db[vuln_type]
                recommendations.append(
                    f"发现 {count} 个 {db_info['description']} 漏洞 ({vuln_type})，"
                    f"建议检查{', '.join(db_info['common_locations'])}相关代码"
                )

        # 基于严重程度的建议
        critical_count = analysis['by_severity'].get('critical', 0)
        if critical_count > 0:
            recommendations.append(
                f"发现 {critical_count} 个严重漏洞，建议立即修复"
            )

        # 基于协议的建议
        for protocol, count in analysis['by_protocol'].items():
            if count > 5:  # 如果某个协议漏洞较多
                recommendations.append(
                    f"协议 {protocol} 发现 {count} 个漏洞，建议加强该协议的测试和验证"
                )

        return recommendations

    def generate_vulnerability_report(self, vulnerabilities: List[Dict[str, Any]]) -> str:
        """生成漏洞报告"""
        analysis = self.analyze_vulnerabilities(vulnerabilities)

        report = [
            "漏洞分析报告",
            "=" * 50,
            f"总漏洞数量: {analysis['total_vulnerabilities']}",
            "",
            "按严重程度分布:"
        ]

        for severity, count in analysis['by_severity'].items():
            report.append(f"  {severity}: {count}")

        report.append("\n按漏洞类型分布:")
        for vuln_type, count in analysis['by_type'].items():
            description = self.vulnerability_db.get(vuln_type, {}).get('description', vuln_type)
            report.append(f"  {vuln_type} ({description}): {count}")

        report.append("\n按协议分布:")
        for protocol, count in analysis['by_protocol'].items():
            report.append(f"  {protocol}: {count}")

        report.append("\n风险评估:")
        risk = analysis['risk_assessment']
        report.append(f"  风险分数: {risk['risk_score']:.2f}")
        report.append(f"  风险等级: {risk['risk_level']}")
        report.append(f"  严重漏洞: {risk['critical_vulnerabilities']}")
        report.append(f"  主要漏洞: {risk['major_vulnerabilities']}")

        report.append("\n修复建议:")
        for i, recommendation in enumerate(risk['recommendations'], 1):
            report.append(f"  {i}. {recommendation}")

        return "\n".join(report)

    def export_to_json(self, vulnerabilities: List[Dict[str, Any]], filename: str):
        """导出漏洞数据到JSON文件"""
        analysis = self.analyze_vulnerabilities(vulnerabilities)

        export_data = {
            'vulnerabilities': vulnerabilities,
            'analysis': analysis,
            'timestamp': '2024-01-01T00:00:00Z',  # 应该使用实际时间戳
            'version': '1.0'
        }

        try:
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(export_data, f, indent=2, ensure_ascii=False)
            self.logger.info(f"漏洞数据已导出到: {filename}")
        except Exception as e:
            self.logger.error(f"导出漏洞数据时出错: {e}")